{% extends 'base_site.html' %}

{% block head %}
  <script type="text/javascript" src="/static/js/jquery/jquery-1.3.2.js"></script>
  <script type="text/javascript" src="/static/js/canvas-text/canvas.text.js"></script>
  <script type="application/x-javascript">
    var ctx;
    var numActions = 0;
    var iActions = 0;
    var numResults = 0;
    var iResults = 0;
    var canvasW = 0;
    var canvasH = 0;
    var nodes = Array();
    var x0 = 0; // location of the canvas
    var y0 = 0; // location of the canvas

    function Node(type,label,objId,addNew){
        this.objId = objId;
        this.type = type;
        this.label = label;
        this.addNew = addNew;
        this.x = 0;
        this.y = 0;
        this.w = 0; // width
        this.h = 0; // height
        switch (this.type){
            case 'action':
                iActions++;
                this.x = 100;
                this.y = 10+(canvasH-20)/(numActions+1)*iActions;
                this.w = 100;
                this.h = 60;
                break;
            case 'result':
                iResults++;                
                this.x = 350;
                this.y = 10+(canvasH-20)/(numResults+1)*iResults;
                this.w = 100;
                this.h = 60;
                break;
            case 'goal':
                this.x = 650;
                this.y = canvasH/2;
                this.w = 140;
                this.h = 100;
                break;
        }

        this.draw = function(){
            ctx.strokeStyle = "rgb(0,0,0)";
            if(this.addNew){
                ctx.fillStyle = "rgb(230,230,230)";
            } else {
                ctx.fillStyle = "rgb(250,250,250)";
            }
            roundedRect(this.x-this.w/2,this.y-this.h/2,this.w,this.h,5);
            ctx.fillStyle = "rgb(0,0,0)";
            drawText(this.label, this.x-5, this.y, this.w);      

        };                
    }

    function roundedRect(x,y,width,height,radius){
      ctx.beginPath();
      ctx.moveTo(x,y+radius);
      ctx.lineTo(x,y+height-radius);
      ctx.quadraticCurveTo(x,y+height,x+radius,y+height);
      ctx.lineTo(x+width-radius,y+height);
      ctx.quadraticCurveTo(x+width,y+height,x+width,y+height-radius);
      ctx.lineTo(x+width,y+radius);
      ctx.quadraticCurveTo(x+width,y,x+width-radius,y);
      ctx.lineTo(x+radius,y);
      ctx.quadraticCurveTo(x,y,x,y+radius);
      ctx.fill();
      ctx.stroke();

    }

    function drawText(text,x,y,maxWidth){
    // if text is short enough - put it in 1 line. if not, search for the middle space, and split it there (only splits to 2 lines).
        if (ctx.measureText(text).width <= maxWidth*0.8){ 
            ctx.fillText(text,x,y);
        } else {
            var spl = text.split(' ');
            var len = Math.floor(spl.length/2);
            var pos = 0;
            for (var i=0; i<len; i++){
                pos = text.indexOf(' ',pos)+1;
            }            
            var text1 = text.substring(0,pos-1);
            var text2 = text.substring(pos);
            ctx.fillText(text1,x,y+10);
            ctx.fillText(text2,x,y-10);
        }
    }

    function init() {
      var canv = document.getElementById('canvas');
      var pos = $("#canvas").position();
      x0 = pos.left;
      y0 = pos.top;
      ctx = canv.getContext('2d');
      canvasW = canv.width;
      canvasH = canv.height;
      ctx.fillStyle = "rgb(230,230,230)";
      ctx.fillRect(0,0,canvasW,canvasH);
      ctx.font = "10px 'arial'";
      ctx.textAlign = 'center';
	  ctx.textBaseline = 'middle';
      ctx.fillStyle = "rgb(230,0,0)";
      $.get("../json/", { 'a': 1, 'b': 2 }, json_cb );
      jQuery(document).ready(function(){
           $("#canvas").click(function(e){
               // $('#status').html((e.pageX-x0).toString() +', '+ (e.pageY-y0).toString());
                var x = e.pageX-x0;
                var y = e.pageY-y0;
                minDist = 99999;
                I = -1;
                for (i=0;i<nodes.length;i++){
                    d = Math.abs(nodes[i].x - x)+Math.abs(nodes[i].y - y); 
                    if(d < minDist) {
                        I = i;
                        minDist = d;
                    }
                }
                alert(nodes[I].label + ' clicked');
           }); 
      })
    }


    function json_cb(data, textStatus){
        // read the json we got from the server, and draw all nodes.
        res = eval('('+data+')');
        numActions = res.actions.length+1;
        nodes = new Array();
        for(i=0;i<numActions-1;i++){ // add a node for each action
            n = new Node('action', res.actions[i].name,res.actions[i].id, false);
            nodes[nodes.length] = n;
        }
        n = new Node('action','add new action',-1, true); // and a node for 'add new action'
        nodes[nodes.length] = n;
        
        numResults = res.results.length+1;
        for(i=0;i<numResults-1;i++){ // add a node for each result
            n = new Node('result',res.results[i].name,res.results[i].id,false);
            nodes[nodes.length] = n;
        }
        n = new Node('result','add new result',0,true); // and for the 'add new result'
        nodes[nodes.length] = n;

        n = new Node('goal',res.goal.name, res.goal.id, false); // add goal node
        nodes[nodes.length] = n;

        for(i=0;i<nodes.length;i++){ // draw all nodes
            nodes[i].draw();
        }

    }
  </script>

{% endblock head %}
{% block title %} :: {{ context.goal.name }} {% endblock title %}
{% block body_declaration %} onload="init();" {% endblock body_declaration %}
{% block content %}
<h1>How to get to {{ context.goal.name }}?</h1><p>Click on an item to add your ideas and opinions regarding it.</p>
<canvas id="canvas" width="800" height="400"></canvas>
<div id=status></div>
{% endblock content %}
